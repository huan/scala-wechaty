<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContactRawSupport.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">wechaty-puppet-padplus_2.12</a> &gt; <a href="index.source.html" class="el_package">wechaty.padplus.support</a> &gt; <span class="el_source">ContactRawSupport.scala</span></div><h1>ContactRawSupport.scala</h1><pre class="source lang-java linenums">package wechaty.padplus.support

import java.util
import java.util.concurrent.TimeUnit

import com.github.benmanes.caffeine.cache.{Cache, Caffeine}
import com.google.zxing.client.j2se.BufferedImageLuminanceSource
import com.google.zxing.common.HybridBinarizer
import com.google.zxing.{BinaryBitmap, DecodeHintType, MultiFormatReader}
import javax.imageio.ImageIO
import wechaty.padplus.PuppetPadplus
import wechaty.padplus.grpc.PadPlusServerOuterClass.{ApiType, ResponseType, StreamResponse}
import wechaty.padplus.schemas.GrpcSchemas.GrpcQrCodeLogin
import wechaty.padplus.schemas.ModelContact.{GrpcContactPayload, PadplusContactPayload}
import wechaty.padplus.schemas.ModelRoom.GrpcRoomPayload
import wechaty.padplus.schemas.ModelUser.ScanData
import wechaty.padplus.schemas.PadplusEnums.QrcodeStatus
import wechaty.puppet.ResourceBox
import wechaty.puppet.schemas.{Contact, Puppet}
import wechaty.puppet.schemas.Contact.{ContactGender, ContactPayload, ContactType}
import wechaty.puppet.schemas.Event.{EventLoginPayload, EventScanPayload}
import wechaty.puppet.schemas.Puppet._

import scala.concurrent.duration._
import scala.concurrent.{Await, Future, Promise}
import scala.util.{Failure, Success, Try}

/**
  *
  * @author &lt;a href=&quot;mailto:jcai@ganshane.com&quot;&gt;Jun Tsai&lt;/a&gt;
  * @since 2020-06-21
  */
<span class="nc" id="L33">trait ContactRawSupport {</span>
  self: PuppetPadplus =&gt;
  protected lazy val contactPromises: Cache[String, List[Promise[PadplusContactPayload]]] = {
<span class="nc" id="L36">    Caffeine.newBuilder().maximumSize(1000).expireAfterWrite(1, TimeUnit.MINUTES).build().asInstanceOf[Cache[String, List[Promise[PadplusContactPayload]]]]</span>
  }

  /**
    *
    * Contact
    *
    */
<span class="nc" id="L44">  override def contactAlias(contactId: String): String = ???</span>

<span class="nc" id="L46">  override def contactAlias(contactId: String, alias: String): Unit = ???</span>

<span class="nc" id="L48">  override def contactAvatar(contactId: String): ResourceBox = ???</span>

<span class="nc" id="L50">  override def contactAvatar(contactId: String, file: ResourceBox): ResourceBox = ???</span>

<span class="nc" id="L52">  override def contactList(): Array[String] = ???</span>

  /**
    * contact
    */
  override protected def contactRawPayload(contactId: String): Contact.ContactPayload = {
<span class="nc" id="L58">    this.getContact(contactId)</span>
  }

  protected def getContact(contactId: String): PadplusContactPayload = {
<span class="nc" id="L62">    Future {</span>
<span class="nc" id="L63">      val json = objectMapper.createObjectNode()</span>
<span class="nc" id="L64">      json.put(&quot;userName&quot;, contactId)</span>
<span class="nc" id="L65">      request(ApiType.GET_CONTACT, Some(json.toString))</span>
    }
<span class="nc" id="L67">    val contactPayloadPromise = Promise[PadplusContactPayload]()</span>
<span class="nc" id="L68">    contactPayloadPromise.future.onComplete {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">      case Success(payload) =&gt; payload</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      case Failure(e) =&gt; throw e</span>
    }
<span class="nc" id="L72">    val oldValue=contactPromises.getIfPresent(contactId)</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">    if(oldValue != null){</span>
<span class="nc" id="L74">      contactPromises.put(contactId, oldValue :+ contactPayloadPromise)</span>
    }else{
<span class="nc" id="L76">      contactPromises.put(contactId, List(contactPayloadPromise))</span>
    }
<span class="nc" id="L78">    Await.result(contactPayloadPromise.future, 10 seconds)</span>
  }

<span class="nc bnc" id="L81" title="All 2 branches missed.">  protected def loginPartialFunction(response: StreamResponse): PartialFunction[ResponseType, Unit] = {</span>
<span class="nc bnc" id="L82" title="All 4 branches missed.">    case ResponseType.QRCODE_SCAN =&gt;</span>
<span class="nc" id="L83">      onQrcodeScan(response)</span>
<span class="nc bnc" id="L84" title="All 4 branches missed.">    case ResponseType.LOGIN_QRCODE =&gt;</span>
<span class="nc" id="L85">      val qrcodeData = objectMapper.readTree(response.getData)</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">      logger.debug(&quot;qrcode:&quot;,response.getData)</span>

<span class="nc" id="L88">      val base64            = qrcodeData.get(&quot;qrcode&quot;).asText().replaceAll(&quot;\r|\n&quot;, &quot;&quot;)</span>
<span class="nc" id="L89">      val fileBox           = ResourceBox.fromBase64(s&quot;qrcode${(Math.random() * 10000).intValue()}.png&quot;, base64)</span>
      //解析二维码的类
<span class="nc" id="L91">      val multiFormatReader = new MultiFormatReader();</span>
      //要解析的二维码的图片
<span class="nc" id="L93">      val bufferedImage     = ImageIO.read(fileBox.toStream);</span>
<span class="nc" id="L94">      val binaryBitmap      = new BinaryBitmap(new HybridBinarizer(new BufferedImageLuminanceSource(bufferedImage)));</span>
      //二维码的参数设置
<span class="nc" id="L96">      val hints             = new util.HashMap[DecodeHintType, String]();</span>
<span class="nc" id="L97">      hints.put(DecodeHintType.CHARACTER_SET, &quot;utf-8&quot;); //设置二维码的编码</span>
    //得到解析结果,
<span class="nc" id="L99">    val result  = multiFormatReader.decode(binaryBitmap, hints);</span>
<span class="nc" id="L100">    val payload = new EventScanPayload</span>
<span class="nc" id="L101">      payload.qrcode = result.getText</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">      logger.debug(&quot;Scan QR Code to login: %s\nhttps://api.qrserver.com/v1/create-qr-code/?data=%s\n&quot;.format(payload.status, payload.qrcode))</span>
<span class="nc" id="L103">      emit(PuppetEventName.SCAN, payload)</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">    case ResponseType.QRCODE_LOGIN =&gt;</span>
<span class="nc" id="L105">      val loginData             = objectMapper.readValue(response.getData, classOf[GrpcQrCodeLogin])</span>
<span class="nc" id="L106">      val padplusContactPayload = new PadplusContactPayload</span>
<span class="nc" id="L107">      padplusContactPayload.alias = loginData.alias</span>
<span class="nc" id="L108">      padplusContactPayload.bigHeadUrl = loginData.headImgUrl</span>
<span class="nc" id="L109">      padplusContactPayload.nickName = loginData.nickName</span>
<span class="nc" id="L110">      padplusContactPayload.sex = ContactGender.Unknown</span>
<span class="nc" id="L111">      padplusContactPayload.userName = loginData.userName</span>
<span class="nc" id="L112">      padplusContactPayload.verifyFlag = 0</span>
<span class="nc" id="L113">      savePadplusContactPayload( padplusContactPayload)</span>
<span class="nc" id="L114">      val eventLoginPayload = new EventLoginPayload</span>
<span class="nc" id="L115">      eventLoginPayload.contactId = padplusContactPayload.userName</span>
<span class="nc" id="L116">      emit(PuppetEventName.LOGIN, eventLoginPayload)</span>

<span class="nc" id="L118">      Future {</span>
<span class="nc" id="L119">        getContact(padplusContactPayload.userName)</span>
      }
<span class="nc bnc" id="L121" title="All 4 branches missed.">    case ResponseType.AUTO_LOGIN =&gt;</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">      logger.debug(&quot;response data:{}&quot;, response.getData)</span>
<span class="nc" id="L123">      val autoLoginData = objectMapper.readTree(response.getData)</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">      if (autoLoginData.get(&quot;online&quot;).asBoolean()) {</span>
<span class="nc" id="L125">        val wechatUser = autoLoginData.get(&quot;wechatUser&quot;)</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (wechatUser != null) {</span>
<span class="nc" id="L128">          val rawContactPayload = new PadplusContactPayload</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">          if (wechatUser.has(&quot;alias&quot;))</span>
<span class="nc" id="L130">            rawContactPayload.alias = wechatUser.get(&quot;alias&quot;).asText(&quot;&quot;)</span>
<span class="nc" id="L131">          rawContactPayload.bigHeadUrl = wechatUser.get(&quot;headImgUrl&quot;).asText()</span>
<span class="nc" id="L132">          rawContactPayload.nickName = wechatUser.get(&quot;nickName&quot;).asText()</span>
<span class="nc" id="L133">          rawContactPayload.sex = ContactGender.Unknown</span>
<span class="nc" id="L134">          rawContactPayload.userName = wechatUser.get(&quot;userName&quot;).asText()</span>
<span class="nc" id="L135">          savePadplusContactPayload(rawContactPayload)</span>
          // &quot;{\&quot;uin\&quot;:1213374243,\&quot;online\&quot;:true,\&quot;wechatUser\&quot;:{\&quot;headImgUrl\&quot;:\&quot;http://wx.qlogo.cn/mmhead/ver_1/iag5D2R2U9ibgTW2eh7XUbPTHqpEMP2DhSpXSBeQYzEPWgEmLIx5IDibwicGh4fTh4IibkL4hNianoiaTzXmVORnm1O4ZjhxfPosKzkMPSwic8Iicylk/0\&quot;,\&quot;nickName\&quot;:\&quot;\351\230\277\350\224\241\&quot;,\&quot;uin\&quot;:1213374243,\&quot;userName\&quot;:\&quot;wxid_gbk03zsepqny22\&quot;,\&quot;alias\&quot;:\&quot;\&quot;,\&quot;verifyFlag\&quot;:0}}&quot;
<span class="nc" id="L137">          selfId = Some(rawContactPayload.userName)</span>
        }

//        contactSelfInfo { padplusContact =&gt;
//          selfId = Some(padplusContact.userName)
//          logger.debug(&quot;contactSelf:{}&quot;, padplusContact)
//          savePadplusContactPayload(padplusContact)
//          val eventLoginPayload = new EventLoginPayload
//          eventLoginPayload.contactId = padplusContact.userName
//          emit(PuppetEventName.LOGIN, eventLoginPayload)
//        }
      } else {
<span class="nc" id="L149">        deleteUin()</span>
<span class="nc" id="L150">        request(ApiType.GET_QRCODE)</span>
      }
<span class="nc bnc" id="L152" title="All 12 branches missed.">    case ResponseType.CONTACT_LIST | ResponseType.CONTACT_MODIFY =&gt;</span>
<span class="nc" id="L153">      val data = response.getData</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">      if(!isBlank(data)){</span>
<span class="nc" id="L155">        val root = objectMapper.readTree(data)</span>
<span class="nc" id="L156">        val userName = root.get(&quot;UserName&quot;).asText()</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if(isRoomId(userName)){</span>
<span class="nc" id="L158">          val roomTry=Try {</span>
<span class="nc" id="L159">            val grpcRoomPayload = objectMapper.readValue(data, classOf[GrpcRoomPayload])</span>
<span class="nc" id="L160">            val roomPayload     = convertRoomFromGrpc(grpcRoomPayload)</span>
            /* //TODO process room members
            const roomMembers = briefRoomMemberParser(roomPayload.members)
            const _roomMembers = await this.cacheManager.getRoomMember(roomPayload.chatroomId)
            if (!_roomMembers) {
              await this.cacheManager.setRoomMember(roomPayload.chatroomId, roomMembers)
            }
            await this.cacheManager.setRoom(roomPayload.chatroomId, roomPayload)
          } else {
            throw new PadplusError(PadplusErrorType.NO_CACHE, `CONTACT_MODIFY`)
          }
           */
<span class="nc" id="L172">            savePadplusRoomPayload(roomPayload)</span>

<span class="nc" id="L174">            roomPayload</span>
          }
<span class="nc" id="L176">          val roomCallback=roomPromises.getIfPresent(userName)</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">          if(roomCallback != null)</span>
<span class="nc" id="L178">            roomCallback.foreach(_.complete(roomTry))</span>

        }else{
<span class="nc" id="L181">          val result:Try[PadplusContactPayload] = Try {</span>
<span class="nc" id="L182">            val contact               = objectMapper.readValue(data, classOf[GrpcContactPayload])</span>
<span class="nc" id="L183">            val padplusContactPayload = convertFromGrpcContact(contact)</span>
<span class="nc" id="L184">            savePadplusContactPayload(padplusContactPayload)</span>
<span class="nc" id="L185">            padplusContactPayload</span>
          }
<span class="nc" id="L187">          val callbacks =contactPromises.getIfPresent(userName)</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">          if(callbacks!=null){</span>
<span class="nc" id="L189">            callbacks.foreach(_.complete(result))</span>
          }
        }
      }
  }

  private def onQrcodeScan(response: StreamResponse): Unit = {
<span class="nc" id="L196">    val scanRawData = response.getData()</span>
<span class="nc" id="L197">    val scanData    = objectMapper.readValue(scanRawData, classOf[ScanData])</span>
<span class="nc" id="L198">    QrcodeStatus(scanData.status.intValue()) match {</span>
<span class="nc bnc" id="L199" title="All 6 branches missed.">      case QrcodeStatus.Scanned =&gt;</span>

<span class="nc bnc" id="L201" title="All 6 branches missed.">      case QrcodeStatus.Confirmed =&gt;</span>
//        contactSelfInfo { padplusContact =&gt;
//          selfId = Some(padplusContact.userName)
//          logger.debug(&quot;contactSelf:{}&quot;, padplusContact)
//          savePadplusContactPayload(padplusContact)
//          val eventLoginPayload = new EventLoginPayload
//          eventLoginPayload.contactId = padplusContact.userName
//          emit(PuppetEventName.LOGIN, eventLoginPayload)
//        }
<span class="nc bnc" id="L210" title="All 14 branches missed.">      case QrcodeStatus.Canceled | QrcodeStatus.Expired =&gt;</span>

    }
  }

  def convertFromGrpcContact (contactPayload: GrpcContactPayload): PadplusContactPayload = {
<span class="nc" id="L216">    val payload = new PadplusContactPayload</span>
<span class="nc" id="L217">    payload.alias            = contactPayload.Alias</span>
<span class="nc" id="L218">    payload.bigHeadUrl       = contactPayload.BigHeadImgUrl</span>
<span class="nc" id="L219">    payload.city             = contactPayload.City</span>
<span class="nc" id="L220">    payload.contactFlag      = contactPayload.ContactFlag</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">    payload.contactType      = if(Puppet.isBlank(contactPayload.ContactType)) 0 else contactPayload.ContactType.toInt</span>
<span class="nc" id="L222">    payload.country          = &quot;&quot;</span>
<span class="nc" id="L223">    payload.nickName         = contactPayload.NickName</span>
<span class="nc" id="L224">    payload.province         = contactPayload.Province</span>
<span class="nc" id="L225">    payload.remark           = contactPayload.RemarkName</span>
<span class="nc" id="L226">    payload.sex              = Contact.ContactGender(contactPayload.Sex.intValue())</span>
<span class="nc" id="L227">    payload.signature        = contactPayload.Signature</span>
<span class="nc" id="L228">    payload.smallHeadUrl     = contactPayload.SmallHeadImgUrl</span>
<span class="nc" id="L229">    payload.stranger         = contactPayload.EncryptUsername</span>
<span class="nc" id="L230">    payload.tagList          = contactPayload.LabelLists</span>
<span class="nc" id="L231">    payload.ticket           = &quot;&quot;</span>
<span class="nc" id="L232">    payload.userName         = contactPayload.UserName</span>
<span class="nc" id="L233">    payload.verifyFlag       = contactPayload.VerifyFlag</span>

<span class="nc" id="L235">    payload</span>
  }
  implicit def convertPadplusContactToContactPayload(rawPayload:PadplusContactPayload): ContactPayload ={
<span class="nc bnc" id="L238" title="All 2 branches missed.">    if (isRoomId(rawPayload.userName)) {</span>
<span class="nc" id="L239">      throw new Error(&quot;Room Object instead of Contact!&quot;)</span>
    }

<span class="nc" id="L242">    var contactType = ContactType.Unknown</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">    if (isContactOfficialId(rawPayload.userName) || rawPayload.verifyFlag != 0) {</span>
<span class="nc" id="L244">      contactType = ContactType.Official</span>
    } else {
<span class="nc" id="L246">      contactType = ContactType.Personal</span>
    }
<span class="nc" id="L248">    var friend = false</span>
<span class="nc bnc" id="L249" title="All 6 branches missed.">    if (rawPayload.contactFlag &gt; 0 &amp;&amp; rawPayload.contactFlag != 0 &amp;&amp; rawPayload.verifyFlag == 0) {</span>
<span class="nc" id="L250">      friend = true</span>
    }
<span class="nc" id="L252">    val payload = new ContactPayload</span>
<span class="nc" id="L253">      payload.alias     = rawPayload.remark</span>
<span class="nc" id="L254">      payload.avatar    = rawPayload.bigHeadUrl</span>
<span class="nc" id="L255">      payload.city      = rawPayload.city</span>
<span class="nc" id="L256">      payload.friend    = friend</span>
<span class="nc" id="L257">      payload.gender    = rawPayload.sex</span>
<span class="nc" id="L258">      payload.id        = rawPayload.userName</span>
<span class="nc" id="L259">      payload.name      = rawPayload.nickName</span>
<span class="nc" id="L260">      payload.province  = rawPayload.province</span>
<span class="nc" id="L261">      payload.signature = (rawPayload.signature).replace(&quot;+&quot;, &quot;&quot;)          // Stay+Foolis</span>
<span class="nc" id="L262">      payload.`type`      = contactType</span>
<span class="nc" id="L263">      payload.weixin    = rawPayload.alias</span>

<span class="nc" id="L265">    payload</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>